// Generated by CoffeeScript 1.6.2
(function() {
  $($(function() {
    var check_load_task, continue_task, current_task, display_task, format_time, ready_task, save_task, set_background_blur, share_options, start_task, update_countdown;

    current_task = null;
    $(document).bind('touchmove', false);
    save_task = function() {
      return localStorage.task = JSON.stringify(current_task);
    };
    check_load_task = function() {
      var task;

      if (localStorage.task) {
        task = JSON.parse(localStorage.task);
        if (task.target_time > Date.now()) {
          current_task = task;
          return continue_task();
        } else {
          return localStorage.task = '';
        }
      }
    };
    set_background_blur = function(intensity) {
      return $('.background-wrapper').css('-webkit-filter', 'blur(' + (intensity * 10).toFixed(4) + 'px)').css('-webkit-transform', 'scale(' + (1 + intensity * 0.5).toFixed(4) + ')');
    };
    format_time = function(total_seconds) {
      var minutes, seconds;

      seconds = total_seconds % 60;
      minutes = Math.floor(total_seconds / 60);
      if (seconds < 10) {
        seconds = '0' + seconds;
      }
      if (minutes < 10) {
        minutes = '0' + minutes;
      }
      return "" + minutes + ":" + seconds;
    };
    update_countdown = function() {
      var seconds_left;

      seconds_left = Math.round((current_task.target_time - Date.now()) / 1000);
      $('#timer-countdown').text(format_time(seconds_left));
      set_background_blur(seconds_left / current_task.time);
      if (seconds_left > 0) {
        return window.setTimeout(update_countdown, 100);
      } else {
        $('#bell').get(0).play();
        $('#taskbutton').show().text('Another one?');
        return $('#timer').hide();
      }
    };
    start_task = function() {
      $('#timer').show();
      if (!current_task.target_time) {
        current_task.target_time = Date.now() + current_task.time * 1000;
      }
      save_task();
      return update_countdown();
    };
    continue_task = function() {
      display_task();
      $('#timer').show();
      $('#taskbutton').hide();
      return update_countdown();
    };
    ready_task = function() {
      $('#taskbutton').hide();
      $('#starttaskbutton').show();
      return $('#taskdisplay').text(current_task.title);
    };
    display_task = function() {
      $('#taskdisplay').text(current_task.title);
      $('.background-wrapper').css('background-image', 'url(' + current_task.image.url + ')');
      $('#imagelicense').html(current_task.image.license.html_string).attr('href', current_task.image.license.url);
      return $('#imageauthor').text(current_task.image.author_name).attr('href', current_task.image.author_url);
    };
    $('#taskbutton').click(function(e) {
      e.preventDefault();
      return $.getJSON('/task.json', function(task) {
        current_task = task;
        display_task();
        return ready_task();
      });
    });
    $('#starttaskbutton').click(function(e) {
      e.preventDefault();
      $('#starttaskbutton').hide();
      return start_task();
    });
    check_load_task();
    share_options = {
      color: 'rgba(255,255,255,0.9)',
      text_font: false,
      background: 'rgba(255,255,255,0.0)',
      icon: 'paper-plane'
    };
    return $('.share').share(share_options);
  }));

}).call(this);
