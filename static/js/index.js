// Generated by CoffeeScript 1.6.2
(function() {
  $($(function() {
    var continue_task, current_task, display_image, display_task, format_time, load_next_task, load_saved_task, next_task, ready_task, save_task, set_background_blur, share_options, start_task, update_countdown, write_task;

    current_task = null;
    next_task = null;
    $(document).bind('touchmove', false);
    save_task = function() {
      return localStorage.task = JSON.stringify(current_task);
    };
    load_saved_task = function() {
      var task;

      if (localStorage.task) {
        task = JSON.parse(localStorage.task);
        if (task.target_time > Date.now()) {
          current_task = task;
          return continue_task();
        } else {
          return localStorage.task = '';
        }
      }
    };
    load_next_task = function() {
      return $.getJSON('/task.json', function(task) {
        var bg_image;

        next_task = task;
        bg_image = new Image();
        return bg_image.src = task.image.url;
      });
    };
    set_background_blur = function(intensity) {
      return $('.background-wrapper').css('-webkit-filter', 'blur(' + (intensity * 10).toFixed(4) + 'px)').css('-webkit-transform', 'scale(' + (1 + intensity * 0.5).toFixed(4) + ')');
    };
    format_time = function(total_seconds) {
      var minutes, seconds;

      seconds = total_seconds % 60;
      minutes = Math.floor(total_seconds / 60);
      if (seconds < 10) {
        seconds = '0' + seconds;
      }
      if (minutes < 10) {
        minutes = '0' + minutes;
      }
      return "" + minutes + ":" + seconds;
    };
    update_countdown = function() {
      var seconds_left;

      seconds_left = Math.round((current_task.target_time - Date.now()) / 1000);
      $('#timer-countdown').text(format_time(seconds_left));
      set_background_blur(seconds_left / current_task.time);
      if (seconds_left > 0) {
        return window.setTimeout(update_countdown, 100);
      } else {
        $('#bell').get(0).play();
        $('#randomtaskbutton').show();
        $('#writetaskbutton').show();
        return $('#timer').hide();
      }
    };
    start_task = function() {
      $('#taskdisplay').removeAttr('contenteditable').blur();
      $('#timer').show();
      if (!current_task.target_time) {
        current_task.target_time = Date.now() + current_task.time * 1000;
      }
      save_task();
      return update_countdown();
    };
    continue_task = function() {
      display_task();
      $('#timer').show();
      $('#randomtaskbutton').hide();
      $('#writetaskbutton').hide();
      return update_countdown();
    };
    ready_task = function() {
      $('#randomtaskbutton').hide();
      $('#writetaskbutton').hide();
      return $('#starttaskbutton').show();
    };
    display_image = function(image) {
      $('.background-wrapper').css('background-image', 'url(' + image.url + ')');
      $('#imagelicense').html(image.license.html_string).attr('href', image.license.url);
      return $('#imageauthor').text(image.author_name).attr('href', image.author_url);
    };
    display_task = function() {
      $('#taskdisplay').text(current_task.title);
      return display_image(current_task.image);
    };
    write_task = function() {
      $('#taskdisplay').attr('contenteditable', 'true').text('').focus();
      $('#starttaskbutton').attr('disabled', 'disabled');
      return display_image(current_task.image);
    };
    $('#randomtaskbutton').click(function(e) {
      e.preventDefault();
      current_task = next_task;
      display_task();
      return ready_task();
    });
    $('#writetaskbutton').click(function(e) {
      e.preventDefault();
      current_task = next_task;
      write_task();
      return ready_task();
    });
    $('#starttaskbutton').click(function(e) {
      e.preventDefault();
      $('#starttaskbutton').hide();
      start_task();
      return load_next_task();
    });
    $('#taskdisplay').on('input', function(e) {
      return $('#starttaskbutton').removeAttr('disabled');
    }).keypress(function(e) {
      if (e.which === 13) {
        if (!$('#taskdisplay').is(':empty')) {
          $('#starttaskbutton').hide();
          start_task();
          load_next_task();
        }
        return false;
      }
    }).focusout(function(e) {
      return $(this).focus();
    });
    load_saved_task();
    load_next_task();
    share_options = {
      color: 'rgba(255,255,255,0.9)',
      text_font: false,
      background: 'rgba(255,255,255,0.0)',
      icon: 'paper-plane'
    };
    return $('.share').share(share_options);
  }));

}).call(this);
