// Generated by CoffeeScript 1.6.2
(function() {
  $($(function() {
    var $body, check_load_task, current_task, format_time, handle_task, save_task, set_background_blur, share_options, update_countdown;

    $body = $('body');
    current_task = null;
    $(document).bind('touchmove', false);
    save_task = function(task) {
      return localStorage.task = JSON.stringify(task);
    };
    check_load_task = function() {
      var task;

      if (localStorage.task) {
        task = JSON.parse(localStorage.task);
        if (task.target_time > Date.now()) {
          return handle_task(task);
        } else {
          return localStorage.task = '';
        }
      }
    };
    set_background_blur = function(intensity) {
      return $('.background-wrapper').css('-webkit-filter', 'blur(' + (intensity * 10).toFixed(4) + 'px)').css('-webkit-transform', 'scale(' + (1 + intensity * 0.5).toFixed(4) + ')');
    };
    format_time = function(total_seconds) {
      var minutes, seconds;

      seconds = total_seconds % 60;
      minutes = Math.floor(total_seconds / 60);
      if (seconds < 10) {
        seconds = '0' + seconds;
      }
      if (minutes < 10) {
        minutes = '0' + minutes;
      }
      return "" + minutes + ":" + seconds;
    };
    update_countdown = function() {
      var seconds_left;

      seconds_left = Math.round((current_task.target_time - Date.now()) / 1000);
      $('#timer-countdown').text(format_time(seconds_left));
      set_background_blur(seconds_left / current_task.time);
      if (seconds_left > 0) {
        return window.setTimeout(update_countdown, 100);
      } else {
        $('#bell').get(0).play();
        $('#taskbutton').show();
        return $('#timer').hide();
      }
    };
    handle_task = function(task) {
      $('#timer').show();
      $('#taskdisplay').text(task.title);
      $('.background-wrapper').css('background-image', 'url(' + task.image.url + ')');
      $('#imagecredits').html(task.image.credits);
      $('#taskbutton').hide();
      if (!task.target_time) {
        task.target_time = Date.now() + task.time * 1000;
      }
      current_task = task;
      save_task(task);
      return update_countdown();
    };
    $('#taskbutton').click(function(e) {
      e.preventDefault();
      return $.getJSON('/task.json', function(task) {
        return handle_task(task);
      });
    });
    check_load_task();
    share_options = {
      color: 'rgba(255,255,255,0.9)',
      text_font: false,
      background: 'rgba(255,255,255,0.0)',
      icon: 'paper-plane'
    };
    return $('.share').share(share_options);
  }));

}).call(this);
